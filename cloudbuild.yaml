# Cloud Build: build and deploy to Cloud Run
substitutions:
_REGION: us-central1
_SERVICE: rfp-data-enricher
_REPO: rfp-enricher
_BQ_LOCATION: europe-southwest1
steps:
- name: 'gcr.io/cloud-builders/docker'
args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$COMMIT_SHA', '.']
- name: 'gcr.io/cloud-builders/docker'
args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$COMMIT_SHA']
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
entrypoint: gcloud
args:
- run
- deploy
- '${_SERVICE}'
- '--region'
- '${_REGION}'
- '--image'
- '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$COMMIT_SHA'
- '--allow-unauthenticated'
- '--set-env-vars'
- 'PROJECT_ID=$PROJECT_ID,DATASET_ID=rfpdata,TABLE=performing_arts_fixed,BQ_LOCATION=${_BQ_LOCATION},ENABLE_TICKETMASTER=1,ENABLE_PLACES=1,ENABLE_EVENTBRITE=1,OPENAI_MODEL=gpt-4o-mini,ROW_DELAY_MIN_MS=30,ROW_DELAY_MAX_MS=180,STOP_ON_GPT_QUOTA=1'
- '--set-secrets'
- 'OPENAI_API_KEY=openai-api-key:latest,TICKETMASTER_KEY=ticketmaster-key:latest,GOOGLE_PLACES_KEY=google-places-key:latest,EVENTBRITE_TOKEN=eventbrite-token:latest'
images:
- '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$COMMIT_SHA'
